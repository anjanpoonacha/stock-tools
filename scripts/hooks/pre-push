#!/usr/bin/env bash

# Git pre-push hook to automatically version bump based on changes
# This hook analyzes commits being pushed and auto-bumps versions if needed

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[PRE-PUSH]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[PRE-PUSH]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[PRE-PUSH]${NC} $1"
}

log_error() {
    echo -e "${RED}[PRE-PUSH]${NC} $1"
}

# Read from stdin: <local ref> <local sha> <remote ref> <remote sha>
while read local_ref local_sha remote_ref remote_sha; do
    log_info "Analyzing changes for push..."

    # Get the branch name
    branch_name=$(echo "$local_ref" | sed 's/refs\/heads\///')
    log_info "Branch: $branch_name"

    # Skip if deleting a branch
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        log_info "Deleting branch, skipping version check"
        exit 0
    fi

    # Get the range of commits being pushed
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, check all commits
        range="$local_sha"
    else
        # Existing branch, check new commits
        range="$remote_sha..$local_sha"
    fi

    # Check if we're on main branch
    if [ "$branch_name" = "main" ] || [ "$branch_name" = "master" ]; then
        log_info "Detected push to main branch"

        # Check for webapp changes (excluding extension directory)
        webapp_changes=$(git diff --name-only "$range" -- . ':(exclude)mio-session-extractor/*' ':(exclude)scripts/*' ':(exclude)dist/*' 2>/dev/null || echo "")

        # Check for extension changes
        extension_changes=$(git diff --name-only "$range" -- mio-session-extractor/ 2>/dev/null || echo "")

        needs_webapp_version=false
        needs_extension_version=false

        # Check if webapp version was manually updated
        if echo "$webapp_changes" | grep -q "package.json"; then
            webapp_version_changed=$(git diff "$range" -- package.json | grep -E '^\+.*"version"' | wc -l)
            if [ "$webapp_version_changed" -eq 0 ]; then
                needs_webapp_version=true
            fi
        elif [ -n "$webapp_changes" ]; then
            needs_webapp_version=true
        fi

        # Check if extension version was manually updated
        if echo "$extension_changes" | grep -q "manifest.json"; then
            extension_version_changed=$(git diff "$range" -- mio-session-extractor/manifest.json | grep -E '^\+.*"version"' | wc -l)
            if [ "$extension_version_changed" -eq 0 ]; then
                needs_extension_version=true
            fi
        elif [ -n "$extension_changes" ]; then
            needs_extension_version=true
        fi

        # Auto-version webapp if needed
        if [ "$needs_webapp_version" = true ]; then
            log_info "Webapp changes detected without version bump"
            log_info "Running auto-version for webapp..."

            if node scripts/version-webapp.js auto "$remote_sha" 2>/dev/null; then
                log_success "Webapp version updated automatically"

                # Add and amend the version change to the last commit
                git add package.json

                # Check if we can amend (only if it's our commit)
                last_commit_author=$(git log -1 --format='%ae')
                git_config_email=$(git config user.email)

                if [ "$last_commit_author" = "$git_config_email" ]; then
                    log_info "Amending last commit with version bump..."
                    git commit --amend --no-edit --no-verify
                    log_warning "Commit amended with version bump. Re-pushing..."
                else
                    log_info "Creating new commit for version bump..."
                    webapp_version=$(node scripts/version-webapp.js current)
                    git commit -m "chore: bump webapp version to $webapp_version [skip ci]" --no-verify
                    log_warning "Version bump committed. Re-pushing..."
                fi

                # Update the local SHA for the push
                local_sha=$(git rev-parse HEAD)
            else
                log_error "Failed to auto-version webapp"
                exit 1
            fi
        fi

        # Auto-version extension if needed
        if [ "$needs_extension_version" = true ]; then
            log_info "Extension changes detected without version bump"
            log_info "Running auto-version for extension..."

            if node scripts/version-extension.js auto "$remote_sha" 2>/dev/null; then
                log_success "Extension version updated automatically"

                # Add and amend the version change to the last commit
                git add mio-session-extractor/manifest.json

                # Check if we can amend (only if it's our commit)
                last_commit_author=$(git log -1 --format='%ae')
                git_config_email=$(git config user.email)

                if [ "$last_commit_author" = "$git_config_email" ]; then
                    log_info "Amending last commit with version bump..."
                    git commit --amend --no-edit --no-verify
                    log_warning "Commit amended with version bump. Re-pushing..."
                else
                    log_info "Creating new commit for version bump..."
                    extension_version=$(node scripts/version-extension.js current)
                    git commit -m "chore: bump extension version to $extension_version [skip ci]" --no-verify
                    log_warning "Version bump committed. Re-pushing..."
                fi

                # Update the local SHA for the push
                local_sha=$(git rev-parse HEAD)
            else
                log_error "Failed to auto-version extension"
                exit 1
            fi
        fi

        if [ "$needs_webapp_version" = true ] || [ "$needs_extension_version" = true ]; then
            log_warning "Versions updated. Please run 'git push' again to push the updated commit."
            exit 1
        fi
    fi

    log_success "Pre-push checks passed!"
done

exit 0
